#!/bin/bash

# Process command line options.
backup=false

while getopts ":b" opt; do
  case ${opt} in
    b )
      backup=true
      ;;
    \? )
      echo "Invalid Option: -$OPTARG" 1>&2
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

# Check if release is already running
if [ -f "release-running" ]; then
    echo "Release is already running. Exiting."
    exit 1
fi

# Check that the right number of arguments are provided
if [ $# -lt 2 ]; then
    echo "Please provide two arguments: environment ('dev', 'test', or 'live') and Git branch"
    exit 1
fi

# Optional backup
if [[ $backup == true ]]; then
    mv README.md README.md.bak
    rm ssbak -rf
    rm ssbak_linux_amd64.tar.gz -rf
    wget https://github.com/axllent/ssbak/releases/download/1.1.3/ssbak_linux_amd64.tar.gz
    tar zxvf ssbak_linux_amd64.tar.gz
    chmod +x ./ssbak 
    ./ssbak -h
    rm ./backup.sspak -rf
    ./ssbak save . ./backup.sspak
    rm ssbak -rf
    rm ssbak_linux_amd64.tar.gz -rf
    rm LICENSE -rf
    rm README.md -rf
    mv README.md.bak README.md
fi

# Set to running
touch release-running;


# not release data in release.log
echo "=========================" >> release.log
echo "Time: $(date). START UPDATE: " >> release.log
echo "=========================" >> release.log
date >> release.log
git describe --all --long >> release.log

# get git
# Git actions with chosen branch
git fetch --all
git checkout $2
git pull origin $2

# Provide a flag: dev / test / live
if [ $1 == "dev" ]; then
    git checkout develop
    git pull origin develop
    composer update --prefer-source
    composer vendor-expose
    vendor/bin/sake dev/build flush=all
elif [ $1 == "test" ]; then
elif [ $1 == "live" ]; then
else
    echo "Invalid argument. Please specify 'dev', 'test', or 'live'"
    exit 1
fi

# Only run the following commands if the argument is not "dev"
if [ $1 != "dev" ]; then
    composer install --prefer-dist --no-dev
    vendor/bin/sake dev/build flush=all
    composer vendor-expose

    git describe --all --long >> release.log

    echo "=========================" >> release.log
    echo "DONE" >> release.log
    echo "=========================" >> release.log
    echo "" >> release.log
    echo "" >> release.log

    ##########################################
    # Ping Release if FIA_RELEASE_PING_URL is set
    ##########################################

    source .env
    if [ -n "$FIA_RELEASE_PING_URL" ]; then
        GIT_HASH=$(git rev-parse HEAD)
        URL_WITH_HASH="${FIA_RELEASE_PING_URL}${GIT_HASH}"
        wget -S -qO- "${URL_WITH_HASH}"
    fi

    echo ""
    echo "DONE"
    echo ""

    ###############################
    # FIX FRONT-END
    ###############################
    if [ $1 == "test" ]; then
        sed -i 's/SS_ENVIRONMENT_TYPE="test"/SS_ENVIRONMENT_TYPE="dev"/g' $FILE_PATH
    elif [ $1 == "live" ]; then
        sed -i 's/SS_ENVIRONMENT_TYPE="live"/SS_ENVIRONMENT_TYPE="dev"/g' $FILE_PATH
    fi

    FILE_PATH="./.env"
    BASE_URL=$(grep -oP 'SS_BASE_URL="\K[^"]+' $FILE_PATH)
    # Remove any trailing slash
    BASE_URL="${BASE_URL%/}"
    NEW_URL="${BASE_URL}/dev/?flush=all"
    wget -O  - $NEW_URL


    # Switch SS_ENVIRONMENT_TYPE back to its original value
    if [ $1 == "test" ]; then
        sed -i 's/SS_ENVIRONMENT_TYPE="dev"/SS_ENVIRONMENT_TYPE="test"/g' $FILE_PATH
    elif [ $1 == "live" ]; then
        sed -i 's/SS_ENVIRONMENT_TYPE="dev"/SS_ENVIRONMENT_TYPE="live"/g' $FILE_PATH
    fi
fi

rm release-running -f
