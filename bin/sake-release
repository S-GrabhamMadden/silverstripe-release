#!/bin/bash
help_and_exit() {
    echo "use -l true / --latest-tag true to release latest tag"
    exit;
}

# Get the options
tag=false
while (( $# )); do
  case $1 in
    -l|--latest-tag)         tag=$2;shift ;;
    
    -b|--branch)             branch=$2;shift ;;
    
    -*)                      printf 'Unknown option: %q\n\n' "$1";
                             help_and_exit 1 ;;
  esac
  shift
done

git show --format="%h" --no-patch >> release.log

# sspak
rm sspak.phar -rf
wget https://silverstripe.github.io/sspak/sspak.phar
chmod +x sspak.phar

# move dumps
rm release-3.sspak -rf
mv release-2.sspak release-3.sspak
mv release-1.sspak release-2.sspak
mv release.sspak release-1.sspak

# dump
php sspak.phar save . --db release.sspak

# get all the latest changes from git - just so you have them. NOT APPLIED
git fetch --all

# check you are on the right branch
git branch

if [ "$tags" = true ] ; then

    # Get new tags from remote
    git fetch --tags
    
    # Get latest tag name
    latestTag=$(git describe --tags `git rev-list --tags --max-count=1`)
    
    # Checkout latest tag
    git checkout $latestTag

else 

    # pull the latest of the current branch, may need to specify the branch - e.g. git pull origin mybranch
    git pull

fi

# install composer - CHECK FOR ERRORS! - best solution: deleted vendor/ folder (rm vendor -rf) - and install from scratch
# this may also help: remove public/resources (rm public/resources -rf)
# this may also help: remove public/_resources (rm public/_resources -rf)
composer install --no-dev

# build database - check for errors
# build database - check for errors
vendor/bin/sake dev/build
vendor/bin/sake dev/build flush=all
sudo -u www-data vendor/bin/sake dev/build flush=all

echo '=============================================='
echo "now open the website with ?flush=all"
echo '=============================================='
echo '=============================================='
echo '=============================================='
echo '=============================================='


# MUST OPEN FRONT-END WITH ?flush=all
